<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mis Datos - Club</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 300px; margin-bottom: 20px; }
    input, select { margin-bottom: 10px; }
  </style>
</head>
<body class="bg-light">

<div class="mb-3">
  <a href="panel-club.html" class="btn btn-secondary">&larr; Volver al Panel</a>
</div>

<div class="container my-4">

  <h2>Mis Datos del Club</h2>

  <!-- ==================== FORMULARIO ==================== -->
  <form id="form-editar-club">

      <input type="text" id="nombreClub" class="form-control" placeholder="Nombre del club" required disabled>
      <input type="email" id="emailClub" class="form-control" placeholder="Correo electrÃ³nico" disabled>
      <input type="tel" id="telefonoClub" class="form-control" placeholder="TelÃ©fono" required disabled>

      <label for="provinciaClub">Provincia:</label>
      <select id="provinciaClub" class="form-select" required disabled>
        <option value="">Seleccionar provincia</option>
      </select>

      <label for="localidadClub">Localidad:</label>
      <select id="localidadClub" class="form-select" required disabled>
        <option value="">Seleccionar localidad</option>
      </select>

      <input type="text" id="direccionClub" class="form-control" placeholder="DirecciÃ³n (opcional)" disabled>
      <input type="number" id="latitudClub" class="form-control" step="any" placeholder="Latitud" required disabled>
      <input type="number" id="longitudClub" class="form-control" step="any" placeholder="Longitud" required disabled>

      <!-- BOTONES DATOS CLUB -->
      <button type="button" id="btn-editar-club" class="btn btn-outline-secondary">
        Modificar datos
      </button>

      <button type="submit" id="btn-guardar-club" class="btn btn-success" style="display:none;">
        Guardar cambios
      </button>

  </form>

  <div id="alerta-edicion-club" class="alert alert-success d-none mt-2">
    âœ… Datos actualizados correctamente.
  </div>

  <hr>

  <!-- ==================== MAPA ==================== -->
  <h5>UbicaciÃ³n en el Mapa</h5>
  <small class="text-muted">HacÃ© clic en el mapa para actualizar la ubicaciÃ³n (solo en modo ediciÃ³n)</small>
  <div id="map"></div>

  <hr>

  <!-- ==================== MERCADOPAGO ==================== -->
  <h5>ConfiguraciÃ³n de MercadoPago</h5>

  <input
    id="input-access-token"
    type="text"
    class="form-control mb-2"
    placeholder="Access Token de MercadoPago"
    disabled
  >

  <div class="d-flex gap-2 mb-2">
    <button type="button" id="btn-editar-token" class="btn btn-outline-secondary">
      Modificar Access Token
    </button>
    <button type="button" id="btn-guardar-access-token" class="btn btn-primary" style="display:none;">
      Guardar Access Token
    </button>
  </div>

  <a href="manual-access-token.html" target="_blank" class="d-block mt-1">Â¿CÃ³mo obtener mi Access Token?</a>
  <div id="mensaje-access-token" class="mt-2"></div>

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
  let clubEmail = localStorage.getItem('clubEmail');
  let clubData = null;
  let map, marker;

  // ==========================================================
  // ðŸ“Œ Cargar provincias y localidades dinÃ¡micamente
  // ==========================================================
  async function cargarProvinciasYLocalidades() {
    const provinciaSelect = document.getElementById('provinciaClub');
    const localidadSelect = document.getElementById('localidadClub');
    localidadSelect.disabled = true;

    try {
      const res = await fetch('https://api.canchalibre.ar/ubicaciones');
      const data = await res.json();

      provinciaSelect.innerHTML = '<option value="">Seleccionar provincia</option>';

      Object.keys(data).forEach(prov => {
        const option = document.createElement('option');
        option.value = prov;
        option.textContent = prov;
        provinciaSelect.appendChild(option);
      });

      provinciaSelect.addEventListener('change', () => {
        const provincia = provinciaSelect.value;
        localidadSelect.innerHTML = '<option value="">Seleccionar localidad</option>';
        localidadSelect.disabled = !provincia;

        if (provincia && data[provincia]) {
          data[provincia].forEach(loc => {
            const option = document.createElement('option');
            option.value = loc;
            option.textContent = loc;
            localidadSelect.appendChild(option);
          });

          if (clubData?.localidad) {
            setTimeout(() => localidadSelect.value = clubData.localidad, 200);
          }
        }
      });

    } catch (err) {
      console.error("Error cargando ubicaciones:", err);
    }
  }

  // ==========================================================
  // ðŸ“Œ Cargar datos del club
  // ==========================================================
  async function cargarDatosClub() {
    try {
      const res = await fetch(`https://api.canchalibre.ar/club/${clubEmail}`);
      clubData = await res.json();

      document.getElementById('nombreClub').value = clubData.nombre || '';
      document.getElementById('emailClub').value = clubData.email || '';
      document.getElementById('telefonoClub').value = clubData.telefono || '';
      document.getElementById('direccionClub').value = clubData.direccion || '';
      document.getElementById('latitudClub').value = clubData.latitud || '';
      document.getElementById('longitudClub').value = clubData.longitud || '';

      if (clubData.mercadoPagoAccessToken) {
        document.getElementById('input-access-token').value = clubData.mercadoPagoAccessToken;
      }

      await cargarProvinciasYLocalidades();

      if (clubData.provincia) {
        document.getElementById('provinciaClub').value = clubData.provincia;
        document.getElementById('provinciaClub').dispatchEvent(new Event('change'));
      }

      if (clubData.latitud && clubData.longitud) {
        map.setView([clubData.latitud, clubData.longitud], 15);
        marker = L.marker([clubData.latitud, clubData.longitud]).addTo(map);
      }

    } catch (err) {
      console.error(err);
      alert("Error cargando datos del club");
    }
  }

  // ==========================================================
  // ðŸ“Œ Modo lectura / ediciÃ³n - DATOS DEL CLUB
  // ==========================================================
  const camposClub = [
    'nombreClub', 'telefonoClub', 'direccionClub',
    'latitudClub', 'longitudClub', 'provinciaClub', 'localidadClub'
  ];

  const btnEditarClub = document.getElementById('btn-editar-club');
  const btnGuardarClub = document.getElementById('btn-guardar-club');

  function modoLecturaClub() {
    camposClub.forEach(id => document.getElementById(id).disabled = true);
    document.getElementById('emailClub').disabled = true;

    btnEditarClub.style.display = 'inline-block';
    btnGuardarClub.style.display = 'none';
  }

  function modoEdicionClub() {
    camposClub.forEach(id => document.getElementById(id).disabled = false);
    document.getElementById('emailClub').disabled = true;

    btnEditarClub.style.display = 'none';
    btnGuardarClub.style.display = 'inline-block';
  }

  btnEditarClub.addEventListener('click', modoEdicionClub);

  // ==========================================================
  // ðŸ“Œ Guardar datos del club
  // ==========================================================
  document.getElementById('form-editar-club').addEventListener('submit', async (e) => {
    e.preventDefault();

    const body = {
      nombre: document.getElementById('nombreClub').value,
      telefono: document.getElementById('telefonoClub').value,
      direccion: document.getElementById('direccionClub').value,
      latitud: document.getElementById('latitudClub').value,
      longitud: document.getElementById('longitudClub').value,
      provincia: document.getElementById('provinciaClub').value,
      localidad: document.getElementById('localidadClub').value,
    };

    try {
      const res = await fetch(`https://api.canchalibre.ar/club/${clubData._id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });

      const data = await res.json();

      if (res.ok) {
        document.getElementById("alerta-edicion-club").classList.remove("d-none");
        modoLecturaClub();
      } else {
        alert(data.error || "Error al guardar datos");
      }

    } catch (err) {
      alert('Error al guardar datos');
    }
  });

  // ==========================================================
  // ðŸ“Œ Modo lectura / ediciÃ³n - ACCESS TOKEN MP
  // ==========================================================
  const inputToken = document.getElementById('input-access-token');
  const btnEditarToken = document.getElementById('btn-editar-token');
  const btnGuardarToken = document.getElementById('btn-guardar-access-token');

  function modoLecturaToken() {
    inputToken.disabled = true;
    btnEditarToken.style.display = 'inline-block';
    btnGuardarToken.style.display = 'none';
  }

  function modoEdicionToken() {
    inputToken.disabled = false;
    btnEditarToken.style.display = 'none';
    btnGuardarToken.style.display = 'inline-block';
  }

  btnEditarToken.addEventListener('click', modoEdicionToken);

  // ==========================================================
  // ðŸ“Œ Guardar Access Token MercadoPago
  // ==========================================================
  btnGuardarToken.addEventListener('click', async () => {
    const token = inputToken.value.trim();
    if (!token) return alert("Debes ingresar el Access Token");

    const res = await fetch(`https://api.canchalibre.ar/club/${clubData._id}/access-token`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ accessToken: token })
    });

    const data = await res.json();
    document.getElementById("mensaje-access-token").textContent = data.mensaje || data.error;

    if (res.ok) {
      modoLecturaToken();
    }
  });

  // ==========================================================
  // ðŸ“Œ InicializaciÃ³n del mapa y carga inicial
  // ==========================================================
  document.addEventListener('DOMContentLoaded', async () => {

    map = L.map('map').setView([-34.6, -58.38], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    map.on('click', function (e) {
      // Solo permitir mover marcador en modo ediciÃ³n de datos
      if (btnGuardarClub.style.display === "none") return;

      const { lat, lng } = e.latlng;
      if (marker) marker.setLatLng(e.latlng);
      else marker = L.marker(e.latlng).addTo(map);

      document.getElementById('latitudClub').value = lat.toFixed(6);
      document.getElementById('longitudClub').value = lng.toFixed(6);
    });

    await cargarDatosClub();
    modoLecturaClub();
    modoLecturaToken();
  });
</script>

<script src="js/footer.js"></script>

</body>
</html>
